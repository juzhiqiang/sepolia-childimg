# Sepolia ChildImg Subgraph

This subgraph indexes the ChildImg contract on Ethereum Sepolia testnet.

## Contract Information
- **Network**: Ethereum Sepolia  
- **Contract Address**: `0x3ae524c8ec173e7081007e1c87193cdf53b78042`
- **Contract Type**: ERC721 (NFT)

## Quick Start

### Prerequisites
- Node.js (v16 or later)
- Yarn or npm  
- The Graph CLI
- Docker (for local development)

### Installation

1. Clone the repository:
```bash
git clone https://github.com/juzhiqiang/sepolia-childimg.git
cd sepolia-childimg
```

2. Install dependencies:
```bash
npm install
# or using make
make install
```

3. Install The Graph CLI globally (if not already installed):
```bash
npm install -g @graphprotocol/graph-cli
```

### Code Generation & Build

**IMPORTANT**: Before building or deploying, you must generate the TypeScript bindings:

```bash
# Generate TypeScript bindings from ABI and schema
npm run codegen
# or
make codegen
```

This creates the `generated/` directory with:
- `generated/ChildImg/ChildImg.ts` - Contract bindings
- `generated/schema.ts` - GraphQL schema types

Then build the subgraph:
```bash
npm run build
# or  
make build
```

### Deploy to The Graph Studio

1. Authenticate with your deploy key:
```bash
graph auth --studio <YOUR_DEPLOY_KEY>
```

2. Deploy:
```bash
npm run deploy
# or
make deploy
```

## Generated Files

The Graph CLI generates TypeScript bindings from your configuration:

### Files Generated by `npm run codegen`:
```
generated/
├── ChildImg/
│   └── ChildImg.ts          # Contract bindings and event types
└── schema.ts                # GraphQL entity types
```

### Import Patterns:
```typescript
// Contract bindings (generated from ABI)
import {
  Approval as ApprovalEvent,
  ApprovalForAll as ApprovalForAllEvent, 
  Transfer as TransferEvent,
  ChildImg
} from "../generated/ChildImg/ChildImg"

// Schema types (generated from schema.graphql)
import {
  Approval,
  ApprovalForAll,
  Transfer,
  Token,
  User
} from "../generated/schema"

// Graph protocol utilities
import { Address, BigInt, log } from "@graphprotocol/graph-ts"
```

## Local Development

### Using Docker

1. Start local Graph node:
```bash
make local
# or
npm run start
```

2. Create subgraph locally:
```bash
make create-local
# or
npm run create-local
```

3. Deploy to local node:
```bash
make deploy-local
# or
npm run deploy-local
```

### Testing

```bash
# Run unit tests
npm run test
# or
make test
```

## Available Commands

### NPM Scripts:
- `npm run codegen` - Generate TypeScript bindings
- `npm run build` - Build the subgraph  
- `npm run deploy` - Deploy to The Graph Studio
- `npm run test` - Run unit tests
- `npm start` - Start local development environment

### Make Commands:
- `make setup` - Complete setup for new developers
- `make codegen` - Generate bindings
- `make build` - Build subgraph
- `make test` - Run tests
- `make deploy` - Deploy to studio
- `make local` - Start local environment
- `make clean` - Clean all generated files

## Entities

### Transfer
Records all token transfers with complete transaction details.

### Approval  
Records individual token approvals between owners and approved addresses.

### ApprovalForAll
Records operator approvals allowing an address to manage all tokens of an owner.

### Token
Represents each NFT with metadata:
- Token ID and owner
- Approved address (if any)
- Token URI (fetched from contract)
- Creation timestamp and block

### User
Represents addresses that interact with the contract, with relationships to owned/approved tokens and transfer history.

## Example Queries

### Get user's tokens
```graphql
query GetUserTokens($owner: Bytes!) {
  user(id: $owner) {
    id
    tokensOwned {
      id
      tokenId
      tokenURI
      createdAtTimestamp
    }
  }
}
```

### Get recent transfers
```graphql
query GetRecentTransfers($first: Int = 10) {
  transfers(first: $first, orderBy: blockTimestamp, orderDirection: desc) {
    id
    from
    to
    tokenId
    blockTimestamp
    transactionHash
  }
}
```

### Get token details
```graphql
query GetToken($tokenId: String!) {
  token(id: $tokenId) {
    id
    tokenId
    owner
    approved
    tokenURI
    createdAtTimestamp
  }
}
```

## Project Structure

```
sepolia-childimg/
├── abis/ChildImg.json        # Contract ABI
├── src/child-img.ts          # Event handlers  
├── tests/                    # Unit tests
├── scripts/                  # Helper scripts
├── generated/               # Generated TypeScript bindings (after codegen)
├── schema.graphql           # GraphQL schema
├── subgraph.yaml           # Subgraph configuration
├── package.json            # Dependencies
├── Makefile               # Development commands
└── README.md              # This file
```

## Troubleshooting

### Common Issues

1. **Import errors for generated files**:
   ```bash
   # Run codegen first
   npm run codegen
   ```

2. **"Cannot find module '../generated/ChildImg/ChildImg'"**:
   - Ensure `npm run codegen` completed successfully
   - Check that `abis/ChildImg.json` exists and is valid JSON

3. **Build fails**:
   ```bash
   # Clean and rebuild
   make clean
   make setup
   ```

4. **Tests fail**:
   - Ensure codegen was run before testing
   - Check test import paths match generated structure

### Development Workflow

```bash
# 1. Setup (first time)
make install
make codegen

# 2. Make changes to handlers/schema
# ... edit src/child-img.ts or schema.graphql ...

# 3. Regenerate and test
make codegen
make test

# 4. Build and deploy
make build
make deploy
```

## Features

✅ **Complete ERC721 Support** - All standard events  
✅ **Token Metadata** - Automatic tokenURI fetching  
✅ **User Relationships** - Track ownership and approvals  
✅ **Transfer History** - Complete audit trail  
✅ **Error Handling** - Robust contract call handling  
✅ **Unit Tests** - Matchstick test framework  
✅ **Local Development** - Docker environment  
✅ **Type Safety** - Full TypeScript bindings  

## Graph Init Equivalent

This subgraph structure is equivalent to:
```bash
graph init --protocol ethereum \
           --network sepolia \
           --contract-name ChildImg \
           --from-contract 0x3ae524c8ec173e7081007e1c87193cdf53b78042 \
           sepolia-childimg
```

## Contributing

1. Fork the repository
2. Make your changes
3. Run `make test` to ensure tests pass
4. Submit a pull request

## License

MIT License